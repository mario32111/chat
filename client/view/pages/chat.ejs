<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <!-- Usamos el CDN de Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 1. SOLUCI√ìN: Cargar el CDN de Socket.IO para definir la funci√≥n 'io()' -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        /* Estilo simple para centrar la app en el viewport */
        .chat-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">

    <div class="chat-container">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl flex flex-col h-[80vh] border border-gray-200">
            <!-- Header -->
            <div class="bg-blue-600 text-white text-center py-4 rounded-t-2xl shadow-md">
                <h1 class="text-xl font-bold">üí¨ Chat Socket.IO</h1>
            </div>
            <!-- Mensajes Container -->
            <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3">
                <!-- Los mensajes se insertar√°n aqu√≠ por JavaScript -->
            </div>
            <!-- Input Form -->
            <form onsubmit="sendMessage(event)" class="flex border-t p-4 bg-gray-50 rounded-b-2xl">
                <input id="messageInput" type="text" placeholder="Escribe un mensaje..."
                    class="flex-1 border-2 border-gray-300 rounded-xl px-4 py-3 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150"
                    autocomplete="off" required />
                <button type="submit"
                    class="ml-3 bg-blue-600 text-white font-semibold px-6 py-3 rounded-xl hover:bg-blue-700 transition duration-150 shadow-md transform hover:scale-[1.02]">
                    Enviar
                </button>
            </form>
        </div>
    </div>

    <script>
        // 2. SOLUCI√ìN: Declarar 'socket' en el √°mbito global para que 'sendMessage' pueda usarla
        let socket;

        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const LOCAL_USER_NAME = 'T√∫';
        async function loadMessages() {
            try {
                // La solicitud GET debe ir a una nueva ruta /getMessages definida en Express
                const response = await fetch('http://localhost:3000/messages');
                if (!response.ok) {
                    throw new Error('No se pudieron cargar los mensajes');
                }
                const messages = await response.json();

                // Limpiar el contenedor antes de renderizar
                messagesContainer.innerHTML = '';

                messages.forEach(msg => {
                    // Asegurar que 'type' est√© presente (asume recibido si no se especifica)
                    renderMessage({ ...msg, type: msg.type || 'received' });
                });
                console.log('Mensajes hist√≥ricos cargados:', messages.length);

            } catch (error) {
                console.error('Error al cargar mensajes:', error);
                renderMessage({
                    userName: 'Sistema',
                    message: 'Error: No se pudo conectar a /getMessages. ¬°Define la ruta en el servidor!',
                    type: 'system'
                });
            }
        }

        function connectToSocket() {
            // Asigna la conexi√≥n a la variable global 'socket'
            socket = io('http://localhost:3001');

            socket.on('chat message', function (msg) {
                console.log('Mensaje recibido del servidor:', msg);
                // Aseg√∫rate de que msg es un objeto si est√°s emitiendo un objeto desde el servidor
                renderMessage({ userName: msg.userName || 'Usuario', message: msg.message, type: 'received' });
            });

            socket.on('error message', function (errorMsg) {
                console.error('Mensaje de error del servidor:', errorMsg);
                renderMessage({ userName: 'Sistema', message: errorMsg, type: 'system' });
            });
        }

        // Funci√≥n para renderizar un solo mensaje en el contenedor
        function renderMessage(data) {
            console.log('Renderizando mensaje:', data);
            const isSelf = data.type === 'sent' || data.userName === LOCAL_USER_NAME;

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isSelf ? 'justify-end' : 'justify-start'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = `max-w-[75%] px-4 py-2 rounded-xl shadow-sm ${isSelf ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'
                }`;

            contentDiv.innerHTML = `
                ${!isSelf ? `<strong class="text-sm font-medium block mb-1">${data.userName || 'Usuario'}</strong>` : ''}
                <p class="text-sm">${data.message}</p>
            `;

            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Funci√≥n para enviar el mensaje
        async function sendMessage(event) {
            event.preventDefault();

            const message = messageInput.value.trim();
            console.log('Enviando mensaje:', message);
            const userName = LOCAL_USER_NAME;

            if (message === '') return;
            // üö® 3. ¬°Ahora 'socket' s√≠ est√° definido globalmente!
            if (!socket) {
                console.error("Socket no conectado. Intente recargar.");
                return;
            }

            // 1. Mostrar el mensaje inmediatamente en la interfaz (optimista)
            renderMessage({ userName, message, type: 'sent' });

            // 2. Enviar el mensaje al servidor Socket.IO
            socket.emit('chat message', { userName, message });

            // 3. Limpiar el input
            messageInput.value = '';
        }

        const viewInit = () => {
            connectToSocket();
            loadMessages(); // Descomentar solo si tienes la ruta /messages implementada en Express
        };

        window.onload = viewInit;
    </script>
</body>

</html>